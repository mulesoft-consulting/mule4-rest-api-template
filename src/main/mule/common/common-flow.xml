<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:error-handler-plugin="http://www.mulesoft.org/schema/mule/error-handler-plugin" xmlns:json-logger="http://www.mulesoft.org/schema/mule/json-logger"
	xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/json-logger http://www.mulesoft.org/schema/mule/json-logger/current/mule-json-logger.xsd
http://www.mulesoft.org/schema/mule/error-handler-plugin http://www.mulesoft.org/schema/mule/error-handler-plugin/current/mule-error-handler-plugin.xsd">
	<sub-flow name="assigning-correlation-id" doc:id="cf764f69-6b6d-4e43-a25d-d7c670ea7e20" >
		<try doc:name="Try" doc:id="b4fa79bf-4ad3-46ae-8f84-4cdc3d91cef6" >
			<try doc:name="Try" doc:id="6c616aae-8187-40b8-8a81-3085e763b22f" >
				<choice doc:name="Choice" doc:id="5cf7312b-5ebe-497d-b7c6-35a03ada9346">
					<when expression="#[p('correlation.impose') == &quot;true&quot;]">
<!-- 						<validation:is-not-null doc:name="Is not null" doc:id="0dbf57a3-0c94-4ce4-8b86-52e8d77d3348" value='#[attributes.headers."x-correlation-id"]'> 
					<error-mapping sourceType="VALIDATION:NULL" targetType="APP:NULL_CORRELATION" />
				</validation:is-not-null>-->
						<validation:is-not-null doc:name="Is not null" doc:id="a5c62ea0-c6cd-42ab-a673-5c33ff511feb" value='#[attributes.headers."x-correlation-id"]'/>
						<set-variable value='#[attributes.headers."x-correlation-id"]' doc:name="set correlationId variable" doc:id="71e865b4-653a-4bb3-87d9-a8fac212f0b0" variableName="correlationId" />
					</when>
					<otherwise>
				<set-variable value='#[if (attributes.headers."x-correlation-id" != null) 
	attributes.headers."x-correlation-id"
else
	correlationId]' doc:name="correlationId" doc:id="98018968-f642-4fb2-ada7-d0f5e89c5cc2" variableName="correlationId" doc:description="Message.correlationId will be automatically populated by the HTTP Listener when no X-Correlation-ID header value given. In this setter, we will take the value from the X-Correlation-ID header if value present, otherwise get it from the message.correlationId that is autogenerated." />
			</otherwise>
		</choice>
				<error-handler >
					<on-error-propagate enableNotifications="true" logException="true" doc:name="handle all errors" doc:id="2ed06031-486d-433c-8e95-6b16317b8afd" type="ANY" >
						<set-variable value="#[output application/json
---
{
	status: 400,
	layer: Mule::p('app.layer'),
	title: &quot;X-Correlation-ID header is compulsory&quot;,
	errorSource: &quot;Client&quot;,
	detail: &quot;X-Correlation-ID header is compulsory&quot;,
	description: &quot;X-Correlation-ID header is compulsory&quot;,
	errorType: &quot;APP:CORRELATION_REQUIRED&quot;,
	correlationId: &quot;UNKNOWN&quot;,	
	referenceId: uuid()
}]" doc:name="errorLog" doc:id="c93a4134-c038-4cf7-8b18-d297bddb0c1c" variableName="errorLog" />
						<json-logger:logger doc:name="Logger" doc:id="7ed8dafb-c3b5-4110-9b46-35200f9285f8" tracePoint="EXCEPTION" message="ANY" config-ref="JSON_Logger_Config" category="ANY">
							<json-logger:content ><![CDATA[#[output application/json
---
{
	errorLog: vars.errorLog
}]]]></json-logger:content>
						</json-logger:logger>
						<set-variable value="#[output application/json
---
[
	{
	status: vars.errorLog.status,
	title:  vars.errorLog.title,
	correlationId: correlationId,
	referenceId: vars.errorLog.referenceId
	}
]]" doc:name="errorInfo" doc:id="cc8c4215-681d-4957-ab99-efe0e2ce06d6" variableName="errorInfo"/>
					</on-error-propagate>
				</error-handler>
			</try>
		</try>
	</sub-flow>
</mule>
